---
layout: post
title:  "SG2D应用播放背景音乐"
date:   2014-12-08 20:15:31
tags : [pl__sg2d,pl__walnut]

---
####移动平台上的SG2D应用程序在切入后台时默认自动暂停音效
如果想使用SG2D引擎开发一款类似音乐播放器的跨平台应用程序，我们需要有音乐在应用程序切入后台时扔继续播放的功能。使用过SG2D的都会发现当应用程序切入后台时我们的应用程序会自动进入暂停状态，音乐也会暂停。在了解SG2D应用程序生命周期（请参见[SG2D应用生命周期与Walnut代理接口》]()）后，你可能会想到在ApplicationDelegate::onPause()中加入继续播放音乐的代码，但实际并不能达到继续播放音乐的效果。这样做的话音乐是可以在后台继续播放，但我们并不能听到声音，当我们再次将应用换到前台时才能听到声音。

我们可以现在用另一种方式解决此问题——**改变SG2D应用程序的原有生命周期函数的调用顺序**。
由于SG2D应用程序在Windows和Mac OSX这样的PC平台上不会调用ApplicationDelegate::onPause和ApplicationDelegate::onResume方法，因此不存在应用切入后台后音乐暂停的现象，因此本篇文章针对Android和iOS这两个移动平台分别展开讨论。

##Android平台解决方案
了解Android的Activity声明周期的同学都知道Android应用在应用切入后台时会调用Activity.onPause()方法，在应用恢复运行前会调用Activity.onResume()方法（不熟悉的请参见[《Managing the Activity Lifecycle》](http://developer.android.com/training/basics/activity-lifecycle/index.html)）。而SG2D的Android的应用程序的也是通过调用这两个方法来控制应用程序暂停和恢复运行状态的，实现步骤可以参看[SG2DActivity]()的Java代码。

SG2DActivity代码片段

    ......
    
    @Override
	public void onPause()
	{
		if (cApplication != 0)
		{
			if (glView != null)
			{
				glView.onPause();
			}
			SG2DNative.applicationPause(cApplication);
		}
		super.onPause();
	}
	
	@Override
	public void onResume()
	{
		if (cApplication != 0)
		{
			if (glView != null)
			{
				glView.onResume();
				glView.requestFocus();
			}
			SG2DNative.applicationResume(cApplication);
		}
		super.onResume();
	}
	
	......

通过上面的代码片段发现Android处理应用暂停、恢复运行状态时调用了SG2DNative.applicationPause()和SG2DNative.applicationResume(）方法，继续剖根问底查看SG2DNative的代码

    static public native void applicationPause(long cApp);
	static public native void applicationResume(long cApp);
	
找到两个native函数的声明，其定义在SG2D/platform/Android/jni/SG2DNative.cpp内

    extern "C" JNIEXPORT void JNICALL Java_com_hugenstar_sg2d_android_SG2DNative_applicationPause(JNIEnv *jenv, jobject obj, jlong cApp)
	{
        AndroidApplication *app = (AndroidApplication*)cApp;
        app->setAllWindowsActiveState(false);
    }
    extern "C" JNIEXPORT void JNICALL Java_com_hugenstar_sg2d_android_SG2DNative_applicationResume(JNIEnv *jenv, jobject obj, jlong cApp)
    {
        AndroidApplication *app = (AndroidApplication*)cApp;
        app->setAllWindowsActiveState(true);
    }
    
看到这里我们知道SG2DActivity是在onPause和onResume方法中通过Appllication::setAllWindowsActiveState()方法来控制SG2D引擎是否处于活跃状态的。

####可以修改MainAcivity.onPause()方法来取消引擎进入不活跃状态来阻止应用程序在切入后台时暂停音乐（这里的MainAcivity是我继承自SG2DActivity的承载SG2D应用的主活动，当然你的可以叫其他名字）。

    @Override
    public void onPause() 
    {
    	//super.onResume();//注释此行取消SG2DActivty的onPause()改变应用活跃状态
    }
	

##iOS平台解决方案
iOS上的实现原理和Android基本一致，但是要添加播放背景音乐的权限和控制界面刷新。

1. 添加播放背景音乐的权限,在info.plist中添加Require background modes节点，再在此节点下添加item值为“App plays audio or streams audio/video using AirPlay”的子节点。
![](http://geequlim.qiniudn.com/QQ20141208-1.png)

2. 修改iOSApph.hpp文件，在ClientApplication类中添加一个布尔值变量用来区分应用是否处于背景状态。并根据此布尔值来决定是否更新显示。

        #pragma once
        class ClientApplication : public IOSApplication
        {
        protected:
            typedef IOSApplication super;
            //应用处于后台标识
            bool  m_boBackgroundModel = false;
        public:
            virtual void runFrame(bool enableSleep = true)
            {
                try{
                    if(!m_boBackgroundModel)//非后台时才更新显示
                        super::runFrame(enableSleep);
                }
                catch (Error &e)
                {
                    trace("[APP FRAME]:%s", e.content().ptr());
                }
             }
            //设置应用程序是否处于后台状态
            void setBackgroundModel(bool bgModel){ m_boBackgroundModel = bgModel; }
        protected:
            virtual void checkResources(unsigned int flags){super::checkResources(flags);}
        };
        
3. 修改AppDelegate.mm添加背景声音播放代码和更改SG2D默认生命周期函数
        
        @implementation AppDelegate
        -(void)applicationDidFinishLaunching:(UIApplication *)application
        {
            checkResources();
            RegisterAppleColorEmojiExtention();
            RegisterUIClasses();
            [super applicationDidFinishLaunching:application];
            [application setIdleTimerDisabled:YES];//保持屏幕常亮
            //进入游戏重置标记数字
            application.applicationIconBadgeNumber = 0;
            
            //申请背景音乐播放
            AVAudioSession *session = [AVAudioSession sharedInstance];
            [session setActive:YES error:nil];
            [session setCategory:AVAudioSessionCategoryPlayback error:nil];
        }
        
        -(void)applicationWillEnterForeground:(UIApplication *)application
        {
            //回到游戏重置标记数字
            application.applicationIconBadgeNumber = 0;
            //设置非后台模式
            ((ClientApplication*) ::application)->setBackgroundModel(false);
        }
        
        - (void)applicationDidEnterBackground:(UIApplication *)application
        {
            //留空阻止SG2D引擎暂停
        }
        
        
        - (void) applicationWillResignActive:(UIApplication *)application
        {
            //设置后台模式
            ((ClientApplication*) ::application)->setBackgroundModel(true);
        }
        
        -(void*)createApplication
        {
            application = new ClientApplication();
            application->setResourceCheckInterval(60);
            return application;
        }
        
        -(void*)createMainWindow
        {
            MainWindow *window = new MainWindow();
            window->setShowStatus(true);
            return window;
        }
        @end
        
        

####通过上述修改SG2D应用程序默认生命周期函数的方式便可以阻止Android、iOS应用程序默认切入后台时进入暂停模式，从而支持播放背景音乐。